---
title: "üîÆ Day 4 - Spell 3: Bootstrap Bootcamp - The Great Dragon Fire Sheep Rescue"
output: html_document
---

## üìñ The Story: Dragon Fire Sheep Rescue! üêëüî•

**URGENT QUEST ALERT!** The ancient Dragon of Mount Statistics has accidentally breathed fire across the Enchanted Meadows, where Farmer Luna (white sheep) and Farmer Obsidian (black sheep) graze their magical flocks. The fire didn't harm the sheep, but created a massive cloud of magical smoke that mixed all the flocks together!

The two farmers are worried and need to know how many of their sheep are mixed together in the smoky field. But here's the problem: the smoke is so thick that shepherds can only see a small group of sheep at a time!

**‚ö° Your Challenge:** Use the ancient art of **Bootstrap Magic** to estimate what percentage of the total flock is black sheep!

```{r setup}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
library(ggplot2)
library(dplyr)
library(infer)  # For rep_sample_n function
set.seed(123)  # For reproducible results
```

## üêë Creating Our Magical Sheep Population
Let's create our mixed flock where 60% are black sheep and 40% are white sheep!

```{r create-sheep-population}
# Create our population of 10000 magical sheep
# 6000 black sheep (60%) and 4000 white sheep (40%)
magical_sheep <- tibble(
  sheep_id = 1:10000,
  sheep_color = factor(c(rep("black", 6000), rep("white", 4000)))
)

# Let's verify our true population proportion
true_black_proportion <- sum(magical_sheep$sheep_color == "black") / nrow(magical_sheep)
print(paste("üéØ True proportion of black sheep in population:", true_black_proportion))

# Visualize our population
sheep_summary <- magical_sheep %>%
  count(sheep_color) %>%
  mutate(proportion = n / sum(n))

ggplot(sheep_summary, aes(x = sheep_color, y = proportion, fill = sheep_color)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("black" = "black", "white" = "lightgray")) +
  labs(title = "üêë True Population: Mixed Sheep Flock",
       x = "Sheep Color", 
       y = "Proportion",
       subtitle = "Population Size: 1000 sheep, 60% black sheep") +
  theme_minimal() +
  theme(legend.position = "none")
```

## üí° What is Bootstrapping?
üêë **The Sheep Magic Trick!** You can only see 20 sheep through the smoke, but you want to know what the whole flock looks like. Bootstrapping is like having a magic hat:

**üé© The Magic Hat Steps:**
1. **Put your 20 sheep in the magic hat** (your original sample through the smoke)
2. **Pull one sheep out, write down its color** (black or white)
3. **PUT IT BACK in the hat!** (this is the magic part - WITH REPLACEMENT)
4. **Repeat 20 times** to create a "pretend new sample"
5. **Do this magic trick hundreds of times** to see all possible pretend samples!

By doing this magic trick hundreds of times, you can imagine what it would be like if you could take hundreds of real samples from the smoky field!

## üîç Phase 1: Your Original Vision (Taking Our First Sample)
You can only see 20 sheep through the smoke. Let's take our first sample!

```{r original-sample}
# Take one original sample of 20 sheep that we can see through the smoke
original_sample <- rep_sample_n(magical_sheep, size = 20)

# Count black vs white sheep in our original sample
original_count <- original_sample %>%
  count(sheep_color) %>%
  mutate(proportion = n / sum(n))

print("üîç Our original sample through the smoke:")
print(original_count)

# Calculate our initial estimate
original_black_prop <- sum(original_sample$sheep_color == "black") / 20
print(paste("üìä Our estimate of black sheep percentage:", round(original_black_prop * 100, 1), "%"))
print(paste("üéØ True black sheep percentage:", round(true_black_proportion * 100, 1), "%"))
```

## üîÑ Phase 2: The Bootstrap Magic Ritual
Now we'll use bootstrap magic! We'll resample from our original sample WITH REPLACEMENT to create many bootstrap samples.

```{r single-bootstrap}
# Let's try one bootstrap resample to see how it works
# We sample WITH REPLACEMENT from our original sample
bootstrap_sample_1 <- original_sample %>%
  ungroup() %>%
  select(sheep_color) %>%
  rep_sample_n(size = 20, replace = TRUE)

bootstrap_prop_1 <- sum(bootstrap_sample_1$sheep_color == "black") / 20
print(paste("üé≤ Bootstrap sample 1 - black sheep proportion:", round(bootstrap_prop_1, 3)))
```

```{r another-bootstrap}
# Let's try another bootstrap sample
bootstrap_sample_2 <- original_sample %>%
  ungroup() %>%
  select(sheep_color) %>%
  rep_sample_n(size = 20, replace = TRUE)

bootstrap_prop_2 <- sum(bootstrap_sample_2$sheep_color == "black") / 20
print(paste("üé≤ Bootstrap sample 2 - black sheep proportion:", round(bootstrap_prop_2, 3)))
```

```{r third-bootstrap}
# And one more to see the variability
bootstrap_sample_3 <- original_sample %>%
  ungroup() %>%
  select(sheep_color) %>%
  rep_sample_n(size = 20, replace = TRUE)

bootstrap_prop_3 <- sum(bootstrap_sample_3$sheep_color == "black") / 20
print(paste("üé≤ Bootstrap sample 3 - black sheep proportion:", round(bootstrap_prop_3, 3)))
```

## üåü The Full Bootstrap Distribution: 1000 Magic Resamples!
Now let's create many bootstrap samples to see the full distribution of possible estimates!

```{r bootstrap-distribution}
# Create 1000 bootstrap samples from our original sample
original_sample_clean <- original_sample %>%
  ungroup() %>%
  select(sheep_color)

bootstrap_results <- original_sample_clean %>%
  rep_sample_n(size = 20, replace = TRUE, reps = 1000) %>%
  group_by(replicate) %>%
  summarize(black_proportion = sum(sheep_color == "black") / 20,
            .groups = "drop")

# Calculate statistics about our bootstrap distribution
bootstrap_mean <- mean(bootstrap_results$black_proportion)
bootstrap_sd <- sd(bootstrap_results$black_proportion)

# Plot the bootstrap distribution
ggplot(bootstrap_results, aes(x = black_proportion)) +
  geom_histogram(binwidth = 0.05, fill = "#89e5ed", color = "white", alpha = 0.7) +
  geom_vline(xintercept = original_black_prop, color = "#ce8ff0", linetype = "dashed", linewidth = 2) +
  geom_vline(xintercept = true_black_proportion, color = "#ea9d69", linetype = "solid", linewidth = 2) +
  geom_vline(xintercept = bootstrap_mean, color = "#62aa55", linetype = "longdash", linewidth = 2) +
  labs(title = "üîÆ Bootstrap Distribution: 1000 Magic Resamples",
       x = "Bootstrap Sample Proportion of Black Sheep", 
       y = "Count",
       subtitle = "Purple line: Our original sample estimate, \n Orange line: True proportion, \n Green line: Mean of bootstrap distribution") +
  theme_minimal()


print(paste("üìä Average of bootstrap proportions:", round(bootstrap_mean, 3)))
print(paste("üìè Spread (standard deviation) of bootstrap proportions:", round(bootstrap_sd, 3)))
print(paste("üîç Our original sample proportion:", round(original_black_prop, 3)))
print(paste("üéØ True population proportion:", round(true_black_proportion, 3)))
```

## üèÜ Phase 3: Creating Our Confidence Prophecy (Confidence Interval)
üéØ **Your Confidence Prophecy!** After doing our magic hat trick many times, we noticed that most of our "pretend samples" gave us similar results. Now we can tell the farmers: "Based on all our magic hat tricks, I'm 90% confident that the true percentage of black sheep in your mixed flock is somewhere in this range!" 

It's like saying "I'm pretty sure the answer is somewhere between these two numbers, but I can't be 100% certain because I could only see a small part of the flock through the smoke."

```{r confidence-interval}
# Calculate 90% confidence interval
# This means we're 90% confident the true proportion is in this range
confidence_level <- 0.90
alpha <- 1 - confidence_level
lower_percentile <- (alpha / 2) * 100
upper_percentile <- (1 - alpha / 2) * 100

confidence_interval <- quantile(bootstrap_results$black_proportion, 
                               probs = c(alpha/2, 1 - alpha/2))

print("üîÆ Our 90% Confidence Prophecy (Confidence Interval):")
print(paste("We are 90% confident that the true proportion of black sheep is between", 
            round(confidence_interval[1], 3), "and", round(confidence_interval[2], 3)))

# Did our confidence interval capture the true value?
captured_truth <- (true_black_proportion >= confidence_interval[1]) & 
                  (true_black_proportion <= confidence_interval[2])

if (captured_truth) {
  print("üéâ SUCCESS! Our confidence interval captured the true proportion!")
} else {
  print("üòÖ Oops! Our confidence interval missed the true proportion this time.")
}

# Visualize our confidence interval

ggplot(bootstrap_results, aes(x = black_proportion)) +
  geom_histogram(binwidth = 0.05, fill = "#89e5ed", color = "white", alpha = 0.7) +
  geom_vline(xintercept = original_black_prop, color = "#ce8ff0", linetype = "dashed", linewidth = 2) +
  geom_vline(xintercept = true_black_proportion, color = "#ea9d69", linetype = "solid", linewidth = 2) +
  geom_vline(xintercept = bootstrap_mean, color = "#62aa55", linetype = "longdash", linewidth = 2) +
  geom_vline(xintercept = confidence_interval[1], color = "#9ecb97", linetype = "dotted", linewidth = 1) +
  geom_vline(xintercept = confidence_interval[2], color = "#9ecb97", linetype = "dotted", linewidth = 1) +
  labs(title = "üîÆ Bootstrap Distribution: 1000 Magic Resamples with 90% Confidence Prophecy",
       x = "Bootstrap Sample Proportion of Black Sheep", 
       y = "Count",
       subtitle = "Purple line: Our original sample estimate, \n Orange line: True proportion, \n Green line: Mean of bootstrap distribution \n Green dotted lines: 90% Confidence Prophecy") +
  theme_minimal()


```

## üé≤ Experiment: What If We Had Different Sample Sizes?
Let's see how our confidence gets better with larger samples!

```{r sample-size-experiment}
# Function to create bootstrap CI for different sample sizes
create_bootstrap_ci <- function(sample_size, n_bootstrap = 500) {
  # Take original sample of given size
  sample_data <- rep_sample_n(magical_sheep, size = sample_size)
  sample_clean <- sample_data %>% ungroup() %>% select(sheep_color)
  
  # Create bootstrap distribution
  bootstrap_dist <- sample_clean %>%
    rep_sample_n(size = sample_size, replace = TRUE, reps = n_bootstrap) %>%
    group_by(replicate) %>%
    summarize(black_proportion = sum(sheep_color == "black") / sample_size,
              .groups = "drop")
  
  # Calculate 90% CI
  ci <- quantile(bootstrap_dist$black_proportion, probs = c(0.05, 0.95))
  
  return(list(
    sample_size = sample_size,
    ci_lower = ci[1],
    ci_upper = ci[2],
    ci_width = ci[2] - ci[1],
    bootstrap_dist = bootstrap_dist
  ))
}

# Compare different sample sizes
sample_sizes <- c(10, 20, 50, 100)
ci_results <- tibble()

for (size in sample_sizes) {
  result <- create_bootstrap_ci(size)
  new_row <- tibble(
    sample_size = result$sample_size,
    ci_lower = result$ci_lower,
    ci_upper = result$ci_upper,
    ci_width = result$ci_width
  )
  ci_results <- bind_rows(ci_results, new_row)
}

print("üî¨ How Sample Size Affects Confidence Interval Width:")
print(ci_results)

# Visualize the effect of sample size
ggplot(ci_results, aes(x = factor(sample_size))) +
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), linewidth = 3, color = "#9ecb97") +
  geom_hline(yintercept = true_black_proportion, color = "#ea9d69", linetype = "dashed") +
  labs(title = "üéØ Magic of Sample Size: Confidence Intervals \nGet Narrower!",
       x = "Sample Size",
       y = "90% Confidence Interval",
       subtitle = "Orange line: True proportion. Green lines: Confidence intervals") +
  theme_minimal()
```

## üéØ Key Magical Discoveries!

**üé© Discovery 1: The Magic Hat Trick (Bootstrap)**
- The magic hat lets us create hundreds of "pretend samples" using only our 20 sheep!
- We always PUT THE SHEEP BACK (with replacement) - that's what makes it magic!
- By doing this trick hundreds of times, we see how much our guesses might change

**üéØ Discovery 2: Confidence Prophecies (Confidence Intervals)**
- A 90% confidence prophecy means: "If 100 shepherds did this same magic trick, about 90 of them would get a range that contains the true answer"
- It's NOT saying "There's a 90% chance the true answer is in MY specific range"
- It tells the farmers a range where the true percentage probably lives

**üîç Discovery 3: More Sheep = Better Prophecies**
- If you can see more sheep through the smoke (bigger samples), your confidence prophecy gets narrower and more precise!
- More sheep = more reliable guesses
- But even with just a few sheep, the magic hat trick still gives useful prophecies!

**‚ö° Discovery 4: Magic Hat vs. Real Field Samples**
- **Real field sampling**: Actually taking hundreds of real samples from the smoky field (impossible!)
- **Magic hat bootstrap**: Creating hundreds of "pretend samples" from your one real sample (possible!)
- The magic hat trick gives us almost the same information as real field sampling!

## üí° Real-World Magic Applications

**üó≥Ô∏è Election Polls:** When news says "Candidate A leads by 5% with a margin of error of ¬±3%", that's a confidence interval from bootstrapping!

**‚öïÔ∏è Medical Research:** Doctors use bootstrap confidence intervals to estimate how effective a new treatment is.

**üéÆ Game Analytics:** Game companies bootstrap user data to estimate what percentage of players will like a new feature.

**üì± App Reviews:** When you see "4.2 stars (¬±0.3)", that confidence interval came from bootstrap magic!

**üå°Ô∏è Climate Science:** Scientists use bootstrapping to estimate temperature trends and their uncertainty ranges.