---
title: "🎃 Day 4 - Spell 6: Halloween Candy Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# 🔮 Day 4 - Spell 6: Halloween Candy Analysis

## 🎯 Mission: Analyze Our Enchanted Forest Candy Investigation

Welcome, Statistical Wizards! It's time to analyze the data from our magical candy investigation. We'll examine both rounds of the Enchanted Forest Neighborhood candy count to see how our sampling worked and who made the best predictions!

## 📊 Step 1: Setting Up Our Magic Tools

```{r load-packages}
# 💡 Load our magical data analysis tools
library(ggplot2)  # For beautiful visualizations
library(dplyr)    # For data cleaning and manipulation
```

## 🧹 Step 2: Load and Clean the Data

```{r load-data}
# 💡 Load the candy count data from both rounds
# Make sure these CSV files are in your datasets folder!

# Round 1 data (replace with your actual file name)
#round1_data <- read.csv("../datasets/candy_round1.csv")
round1_data <- read.csv("docs/day04/datasets/candy_round1.csv")

# Round 2 data (replace with your actual file name)  
#round2_data <- read.csv("../datasets/candy_round2.csv")
round2_data <- read.csv("docs/day04/datasets/candy_round2.csv")

# Let's peek at our data structure
cat("🔍 Round 1 Data Structure:\n")
head(round1_data)

cat("\n🔍 Round 2 Data Structure:\n")
head(round2_data)
```

```{r clean-data}
# 🧹 Clean the data - remove any test entries and fix data types

# Function to clean candy data
clean_candy_data <- function(data, round_name) {
  cleaned <- data %>%
    # Remove test entries (like "test" in candy count)
    filter(!grepl("test|Test|TEST", .data[[colnames(data)[3]]])) %>%
    # Convert candy count to numeric
    mutate(
      candy_count = as.numeric(.data[[colnames(data)[3]]]),
      wizard_name = .data[[colnames(data)[2]]],
      decision = .data[[colnames(data)[4]]],
      # Calculate candy percentage (assuming 10 items per bag)
      candy_percentage = .data[["candy_count"]] / 10 * 100,
      round = round_name
    ) %>%
    # Remove rows with invalid candy counts
    filter(!is.na(.data[["candy_count"]]), .data[["candy_count"]] >= 0, .data[["candy_count"]] <= 10) %>%
    # Keep only the columns we need
    select(.data[["wizard_name"]], .data[["candy_count"]], .data[["candy_percentage"]], .data[["decision"]], .data[["round"]])
  
  return(cleaned)
}

# Clean both datasets
round1_clean <- clean_candy_data(round1_data, "Round 1")
round2_clean <- clean_candy_data(round2_data, "Round 2")

cat("✨ Cleaned Data Summary:\n")
cat("Round 1 wizards:", nrow(round1_clean), "\n")
cat("Round 2 wizards:", nrow(round2_clean), "\n")
```

## 🏆 Step 3: Set the True Population Parameter

```{r set-parameters}
# 🎯 Set the TRUE candy percentage for the Enchanted Forest Neighborhood
# You can change this value based on what the instructor set!
TRUE_CANDY_PERCENTAGE <- 70  # Change this if needed!

# 🏰 Determine the correct answer based on the 80% safety threshold
CORRECT_ANSWER <- ifelse(TRUE_CANDY_PERCENTAGE >= 80, "SAFE", "CURSED")

cat("🔮 TRUE candy percentage in the neighborhood:", TRUE_CANDY_PERCENTAGE, "%\n")
cat("🏆 CORRECT answer should be:", CORRECT_ANSWER, "\n")
```

## 📈 Step 4: Round 1 Analysis

### 4.1 Sampling Distribution for Round 1

```{r round1-distribution}
# 📊 Create a histogram showing everyone's candy percentages from Round 1
ggplot(round1_clean, aes(x = candy_percentage)) +
  geom_histogram(bins = 10, fill = "orange", color = "black", alpha = 0.7) +
  geom_vline(xintercept = TRUE_CANDY_PERCENTAGE, color = "red", size = 2, linetype = "dashed") +
  geom_vline(xintercept = mean(round1_clean$candy_percentage), color = "blue", size = 2) +
  labs(
    title = "🎃 Round 1: Sampling Distribution of Candy Percentages",
    subtitle = paste("Red line = True value (", TRUE_CANDY_PERCENTAGE, "%), Blue line = Sample average"),
    x = "Candy Percentage (%)",
    y = "Number of Wizards"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))
```

### 4.2 Calculate Round 1 Statistics

```{r round1-stats}
# 📊 Calculate important statistics for Round 1
round1_avg <- mean(round1_clean$candy_percentage)
round1_std <- sd(round1_clean$candy_percentage)

cat("🎯 Round 1 Results:\n")
cat("Sample average:", round(round1_avg, 2), "%\n")
cat("True population parameter:", TRUE_CANDY_PERCENTAGE, "%\n")
cat("Difference from truth:", round(abs(round1_avg - TRUE_CANDY_PERCENTAGE), 2), "%\n")
cat("Sample standard deviation:", round(round1_std, 2), "%\n")
```

### 4.3 Who Got It Right in Round 1?

```{r round1-winners}
# 🏆 Find wizards who made the correct prediction in Round 1
round1_with_correct <- round1_clean %>%
  mutate(
    predicted_answer = case_when(
      grepl("SAFE", decision, ignore.case = TRUE) ~ "SAFE",
      grepl("CURSED", decision, ignore.case = TRUE) ~ "CURSED",
      TRUE ~ "UNKNOWN"
    ),
    got_it_right = predicted_answer == CORRECT_ANSWER
  )

# List the winners
round1_winners <- round1_with_correct %>%
  filter(got_it_right == TRUE)

cat("🏆 Round 1 Winners (Wizards who got it right):\n")
if(nrow(round1_winners) > 0) {
  for(i in seq_len(nrow(round1_winners))) {
    cat("⭐", round1_winners$wizard_name[i], "- Found", round1_winners$candy_count[i], "candies\n")
  }
} else {
  cat("No wizards got it exactly right this round!\n")
}

# Count SAFE vs CURSED predictions
round1_summary <- round1_with_correct %>%
  count(predicted_answer) %>%
  filter(predicted_answer %in% c("SAFE", "CURSED"))

cat("\n📊 Round 1 Prediction Summary:\n")
for(i in seq_len(nrow(round1_summary))) {
  cat(round1_summary$predicted_answer[i], ":", round1_summary$n[i], "wizards\n")
}
```

## 📈 Step 5: Round 2 Analysis

### 5.1 Sampling Distribution for Round 2

```{r round2-distribution}
# 📊 Create a histogram showing everyone's candy percentages from Round 2
ggplot(round2_clean, aes(x = candy_percentage)) +
  geom_histogram(bins = 10, fill = "purple", color = "black", alpha = 0.7) +
  geom_vline(xintercept = TRUE_CANDY_PERCENTAGE, color = "red", size = 2, linetype = "dashed") +
  geom_vline(xintercept = mean(round2_clean$candy_percentage), color = "blue", size = 2) +
  labs(
    title = "🎃 Round 2: Sampling Distribution of Candy Percentages",
    subtitle = paste("Red line = True value (", TRUE_CANDY_PERCENTAGE, "%), Blue line = Sample average"),
    x = "Candy Percentage (%)",
    y = "Number of Wizards"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))
```

### 5.2 Calculate Round 2 Statistics

```{r round2-stats}
# 📊 Calculate important statistics for Round 2
round2_avg <- mean(round2_clean$candy_percentage)
round2_std <- sd(round2_clean$candy_percentage)

cat("🎯 Round 2 Results:\n")
cat("Sample average:", round(round2_avg, 2), "%\n")
cat("True population parameter:", TRUE_CANDY_PERCENTAGE, "%\n")
cat("Difference from truth:", round(abs(round2_avg - TRUE_CANDY_PERCENTAGE), 2), "%\n")
cat("Sample standard deviation:", round(round2_std, 2), "%\n")
```

### 5.3 Who Got It Right in Round 2?

```{r round2-winners}
# 🏆 Find wizards who made the correct prediction in Round 2
round2_with_correct <- round2_clean %>%
  mutate(
    predicted_answer = case_when(
      grepl("SAFE", decision, ignore.case = TRUE) ~ "SAFE",
      grepl("CURSED", decision, ignore.case = TRUE) ~ "CURSED",
      TRUE ~ "UNKNOWN"
    ),
    got_it_right = predicted_answer == CORRECT_ANSWER
  )

# List the winners
round2_winners <- round2_with_correct %>%
  filter(got_it_right == TRUE)

cat("🏆 Round 2 Winners (Wizards who got it right):\n")
if(nrow(round2_winners) > 0) {
  for(i in seq_len(nrow(round2_winners))) {
    cat("⭐", round2_winners$wizard_name[i], "- Found", round2_winners$candy_count[i], "candies\n")
  }
} else {
  cat("No wizards got it exactly right this round!\n")
}

# Count SAFE vs CURSED predictions
round2_summary <- round2_with_correct %>%
  count(predicted_answer) %>%
  filter(predicted_answer %in% c("SAFE", "CURSED"))

cat("\n📊 Round 2 Prediction Summary:\n")
for(i in seq_len(nrow(round2_summary))) {
  cat(round2_summary$predicted_answer[i], ":", round2_summary$n[i], "wizards\n")
}
```

## 🔍 Step 6: Compare Both Rounds

### 6.1 Overlay the Distributions

```{r overlay-distributions}
# 🎨 Combine both datasets for comparison
combined_data <- bind_rows(round1_clean, round2_clean)

# Create overlapping histograms
ggplot(combined_data, aes(x = candy_percentage, fill = round)) +
  geom_histogram(bins = 10, alpha = 0.6, position = "identity", color = "black") +
  geom_vline(xintercept = TRUE_CANDY_PERCENTAGE, color = "red", size = 2, linetype = "dashed") +
  geom_vline(xintercept = round1_avg, color = "orange", size = 1, linetype = "dotted") +
  geom_vline(xintercept = round2_avg, color = "purple", size = 1, linetype = "dotted") +
  scale_fill_manual(values = c("Round 1" = "orange", "Round 2" = "purple")) +
  labs(
    title = "🎃 Comparison: Round 1 vs Round 2 Sampling Distributions",
    subtitle = "Red = True value, Orange dotted = Round 1 avg, Purple dotted = Round 2 avg",
    x = "Candy Percentage (%)",
    y = "Number of Wizards",
    fill = "Round"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))
```

### 6.2 Statistical Comparison

```{r compare-rounds}
cat("🔮 FINAL COMPARISON RESULTS:\n")
cat(paste(rep("=", 50), collapse = ""), "\n")

cat("📊 Sample Averages:\n")
cat("Round 1 average:", round(round1_avg, 2), "% (difference from truth:", round(abs(round1_avg - TRUE_CANDY_PERCENTAGE), 2), "%)\n")
cat("Round 2 average:", round(round2_avg, 2), "% (difference from truth:", round(abs(round2_avg - TRUE_CANDY_PERCENTAGE), 2), "%)\n")

cat("\n📏 Sample Spreads (Standard Deviation):\n")
cat("Round 1 spread:", round(round1_std, 2), "%\n")
cat("Round 2 spread:", round(round2_std, 2), "%\n")

# Determine which round was closer to truth
round1_error <- abs(round1_avg - TRUE_CANDY_PERCENTAGE)
round2_error <- abs(round2_avg - TRUE_CANDY_PERCENTAGE)

if(round1_error < round2_error) {
  winner_round <- "Round 1"
  better_error <- round1_error
} else if(round2_error < round1_error) {
  winner_round <- "Round 2"
  better_error <- round2_error
} else {
  winner_round <- "TIE"
  better_error <- round1_error
}

cat("\n🏆 WINNER: ", winner_round, " was closer to the true population parameter!\n")
if(winner_round != "TIE") {
  cat("📈 The winning round was only", round(better_error, 2), "% away from the truth!\n")
}

cat("\n🎯 Sample Sizes:\n")
cat("Round 1:", nrow(round1_clean), "wizards\n")
cat("Round 2:", nrow(round2_clean), "wizards\n")

# Check if the larger sample was more accurate
larger_sample_round <- ifelse(nrow(round1_clean) > nrow(round2_clean), "Round 1", 
                             ifelse(nrow(round2_clean) > nrow(round1_clean), "Round 2", "Same"))

cat("\n💡 Magic Learning:\n")
if(larger_sample_round != "Same") {
  cat("The larger sample size was in", larger_sample_round, "\n")
  if((larger_sample_round == "Round 1" && round1_error < round2_error) ||
     (larger_sample_round == "Round 2" && round2_error < round1_error)) {
    cat("✅ As expected, the larger sample gave us a result closer to the truth!\n")
  } else {
    cat("🤔 Interesting! The larger sample wasn't more accurate this time - that's the randomness of sampling!\n")
  }
}
```

## 🎉 Step 7: Celebration and Learning Summary

```{r final-summary}
cat("🎊 CONGRATULATIONS, STATISTICAL WIZARDS! 🎊\n")
cat(paste(rep("=", 50), collapse = ""), "\n")

cat("🔮 What We Discovered:\n")
cat("• Sampling variability is real - different samples give different results!\n")
cat("• Even with randomness, our sample averages got close to the true value\n")
cat("• Larger samples generally give more reliable results\n")
cat("• Every wizard's data contributed to our understanding!\n")

total_winners <- nrow(round1_winners) + nrow(round2_winners)
cat("\n🏆 Total Prediction Winners Across Both Rounds:", total_winners, "wizards!\n")

cat("\n✨ Remember: In real statistical work, we usually don't know the true population parameter - \n")
cat("   that's what makes sampling and estimation so important!\n")
```

---

## 💡 Key Learning Points:

1. **Sampling Variability**: Different samples from the same population give different results
2. **Sample Average**: Tends to be close to the true population parameter, especially with larger samples
3. **Spread**: Shows how much variation there is in our sample results
4. **Sample Size Matters**: Larger samples generally give more reliable estimates
5. **Prediction Accuracy**: Even with sampling variability, statistical methods help us make good predictions!

---

*🎭 End of Spell 6: Halloween Candy Analysis - Great work, Statistical Wizards!*